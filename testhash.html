<!DOCTYPE html>
<html>

<head>
    <title>My Form</title>
    <script src="https://player.vimeo.com/api/player.js"></script>
</head>

<body>
    <div id="header">
        <h1 id="greeting"></h1>
        <h2>please answer the following questions.</h2>
        <h3>(and get a free gift card upon completion)</h3>
    </div>
    <div id="main">
        <form id="questionnaire-form">
            <label for="q1">Have you fallen in the past year?</label>
            <input type="radio" name="q1" value="yes" required>Yes<br>
            <input type="radio" name="q1" value="no">No<br>
            <label for="q2">Have you talked to a doctor about falling in the past year?</label>
            <input type="radio" name="q2" value="yes" required>Yes<br>
            <input type="radio" name="q2" value="no">No<br>
            <div id="video">
                <h1>Please watch this</h1>
                <div id="player"></div>
            </div>
            <button type="submit">Submit</button>
        </form>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        var options = {
            id: '399315834',
            width: 640,
            height: 360,
            autopause: true,
            autoplay: false,
            muted: false
        };

        var player = new Vimeo.Player('player', options);

        const baseUrl = "http://localhost:8080/fhir";
        const patientId = window.location.hash.substring(1);
        const questionnaireId = 16;

        $.ajax({
            url: baseUrl + "/Patient/" + patientId,
            type: "GET",
            success: function (response) {
                const name = response.name[0].given[0];
                document.getElementById('greeting').textContent = "Hi " + name + "!";
            },
            error: function (error) {
                console.log("Error getting questionnaire responses:", error);
            }
        });


        $("#questionnaire-form").on("submit", function (e) {
            e.preventDefault();

            player.getCurrentTime().then(function (seconds) {
                player.getDuration().then(function (duration) {

                    const questionnaireResponse = {
                        resourceType: "QuestionnaireResponse",
                        questionnaire: `Questionnaire/${questionnaireId}`,
                        status: "completed",
                        subject: {
                            reference: `Patient/${patientId}`,
                        },
                        item: [
                            {
                                linkId: "1",
                                answer: [
                                    {
                                        valueCoding: {
                                            code: $("input[name='q1']:checked").val()
                                        },
                                    },
                                ],
                            },
                            {
                                linkId: "2",
                                answer: [
                                    {
                                        valueCoding: {
                                            code: $("input[name='q2']:checked").val()
                                        },
                                    },
                                ],
                            },
                            {
                                linkId: "3",
                                answer: [
                                    {
                                        valueDecimal: seconds / duration,
                                    },
                                ],
                            },
                        ],
                    };

                    $.ajax({
                        url: `${baseUrl}/QuestionnaireResponse`,
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(questionnaireResponse),
                        success: function (response) {
                            console.log("Questionnaire response created:", response);
                        },
                        error: function (error) {
                            console.log("Error creating questionnaire response:", error);
                        },
                    });

                });
            });
        });
    </script>
</body>

</html>